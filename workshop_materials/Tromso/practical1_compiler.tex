% Options for packages loaded elsewhere
% Options for packages loaded elsewhere
\PassOptionsToPackage{unicode}{hyperref}
\PassOptionsToPackage{hyphens}{url}
\PassOptionsToPackage{dvipsnames,svgnames,x11names}{xcolor}
%
\documentclass[
  letterpaper,
  DIV=11,
  numbers=noendperiod]{scrartcl}
\usepackage{xcolor}
\usepackage{amsmath,amssymb}
\setcounter{secnumdepth}{5}
\usepackage{iftex}
\ifPDFTeX
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
  \usepackage{textcomp} % provide euro and other symbols
\else % if luatex or xetex
  \usepackage{unicode-math} % this also loads fontspec
  \defaultfontfeatures{Scale=MatchLowercase}
  \defaultfontfeatures[\rmfamily]{Ligatures=TeX,Scale=1}
\fi
\usepackage{lmodern}
\ifPDFTeX\else
  % xetex/luatex font selection
\fi
% Use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
\IfFileExists{microtype.sty}{% use microtype if available
  \usepackage[]{microtype}
  \UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\makeatletter
\@ifundefined{KOMAClassName}{% if non-KOMA class
  \IfFileExists{parskip.sty}{%
    \usepackage{parskip}
  }{% else
    \setlength{\parindent}{0pt}
    \setlength{\parskip}{6pt plus 2pt minus 1pt}}
}{% if KOMA class
  \KOMAoptions{parskip=half}}
\makeatother
% Make \paragraph and \subparagraph free-standing
\makeatletter
\ifx\paragraph\undefined\else
  \let\oldparagraph\paragraph
  \renewcommand{\paragraph}{
    \@ifstar
      \xxxParagraphStar
      \xxxParagraphNoStar
  }
  \newcommand{\xxxParagraphStar}[1]{\oldparagraph*{#1}\mbox{}}
  \newcommand{\xxxParagraphNoStar}[1]{\oldparagraph{#1}\mbox{}}
\fi
\ifx\subparagraph\undefined\else
  \let\oldsubparagraph\subparagraph
  \renewcommand{\subparagraph}{
    \@ifstar
      \xxxSubParagraphStar
      \xxxSubParagraphNoStar
  }
  \newcommand{\xxxSubParagraphStar}[1]{\oldsubparagraph*{#1}\mbox{}}
  \newcommand{\xxxSubParagraphNoStar}[1]{\oldsubparagraph{#1}\mbox{}}
\fi
\makeatother

\usepackage{color}
\usepackage{fancyvrb}
\newcommand{\VerbBar}{|}
\newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
% Add ',fontsize=\small' for more characters per line
\usepackage{framed}
\definecolor{shadecolor}{RGB}{241,243,245}
\newenvironment{Shaded}{\begin{snugshade}}{\end{snugshade}}
\newcommand{\AlertTok}[1]{\textcolor[rgb]{0.68,0.00,0.00}{#1}}
\newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.37,0.37,0.37}{#1}}
\newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.40,0.45,0.13}{#1}}
\newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.68,0.00,0.00}{#1}}
\newcommand{\BuiltInTok}[1]{\textcolor[rgb]{0.00,0.23,0.31}{#1}}
\newcommand{\CharTok}[1]{\textcolor[rgb]{0.13,0.47,0.30}{#1}}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.37,0.37,0.37}{#1}}
\newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.37,0.37,0.37}{\textit{#1}}}
\newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.00,0.23,0.31}{\textbf{#1}}}
\newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.68,0.00,0.00}{#1}}
\newcommand{\DecValTok}[1]{\textcolor[rgb]{0.68,0.00,0.00}{#1}}
\newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.37,0.37,0.37}{\textit{#1}}}
\newcommand{\ErrorTok}[1]{\textcolor[rgb]{0.68,0.00,0.00}{#1}}
\newcommand{\ExtensionTok}[1]{\textcolor[rgb]{0.00,0.23,0.31}{#1}}
\newcommand{\FloatTok}[1]{\textcolor[rgb]{0.68,0.00,0.00}{#1}}
\newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.28,0.35,0.67}{#1}}
\newcommand{\ImportTok}[1]{\textcolor[rgb]{0.00,0.46,0.62}{#1}}
\newcommand{\InformationTok}[1]{\textcolor[rgb]{0.37,0.37,0.37}{#1}}
\newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.00,0.23,0.31}{\textbf{#1}}}
\newcommand{\NormalTok}[1]{\textcolor[rgb]{0.00,0.23,0.31}{#1}}
\newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.37,0.37,0.37}{#1}}
\newcommand{\OtherTok}[1]{\textcolor[rgb]{0.00,0.23,0.31}{#1}}
\newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.68,0.00,0.00}{#1}}
\newcommand{\RegionMarkerTok}[1]{\textcolor[rgb]{0.00,0.23,0.31}{#1}}
\newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.37,0.37,0.37}{#1}}
\newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.13,0.47,0.30}{#1}}
\newcommand{\StringTok}[1]{\textcolor[rgb]{0.13,0.47,0.30}{#1}}
\newcommand{\VariableTok}[1]{\textcolor[rgb]{0.07,0.07,0.07}{#1}}
\newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.13,0.47,0.30}{#1}}
\newcommand{\WarningTok}[1]{\textcolor[rgb]{0.37,0.37,0.37}{\textit{#1}}}

\usepackage{longtable,booktabs,array}
\usepackage{calc} % for calculating minipage widths
% Correct order of tables after \paragraph or \subparagraph
\usepackage{etoolbox}
\makeatletter
\patchcmd\longtable{\par}{\if@noskipsec\mbox{}\fi\par}{}{}
\makeatother
% Allow footnotes in longtable head/foot
\IfFileExists{footnotehyper.sty}{\usepackage{footnotehyper}}{\usepackage{footnote}}
\makesavenoteenv{longtable}
\usepackage{graphicx}
\makeatletter
\newsavebox\pandoc@box
\newcommand*\pandocbounded[1]{% scales image to fit in text height/width
  \sbox\pandoc@box{#1}%
  \Gscale@div\@tempa{\textheight}{\dimexpr\ht\pandoc@box+\dp\pandoc@box\relax}%
  \Gscale@div\@tempb{\linewidth}{\wd\pandoc@box}%
  \ifdim\@tempb\p@<\@tempa\p@\let\@tempa\@tempb\fi% select the smaller of both
  \ifdim\@tempa\p@<\p@\scalebox{\@tempa}{\usebox\pandoc@box}%
  \else\usebox{\pandoc@box}%
  \fi%
}
% Set default figure placement to htbp
\def\fps@figure{htbp}
\makeatother





\setlength{\emergencystretch}{3em} % prevent overfull lines

\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}



 


% load packages
\usepackage{geometry}
\usepackage{xcolor}
\usepackage{eso-pic}
\usepackage{fancyhdr}
\usepackage{sectsty}
\usepackage{fontspec}
\usepackage{titlesec}

%% Set page size with a wider right margin
\geometry{a4paper, total={170mm,257mm}, left=20mm, top=20mm, bottom=20mm, right=50mm}

%% Let's define some colours
\definecolor{light}{HTML}{E6E6FA}
\definecolor{highlight}{HTML}{800080}
\definecolor{dark}{HTML}{330033}

%% Let's add the border on the right hand side 
\AddToShipoutPicture{% 
    \AtPageLowerLeft{% 
        \put(\LenToUnit{\dimexpr\paperwidth-3cm},0){% 
            \color{light}\rule{3cm}{\LenToUnit\paperheight}%
          }%
     }%
     % logo
    \AtPageLowerLeft{% start the bar at the bottom right of the page
        \put(\LenToUnit{\dimexpr\paperwidth-2.25cm},27.2cm){% move it to the top right
            \color{light}\includegraphics[width=1.5cm]{_extensions/nrennie/PrettyPDF/logo.png}
          }%
     }%
}

%% Style the page number
\fancypagestyle{mystyle}{
  \fancyhf{}
  \renewcommand\headrulewidth{0pt}
  \fancyfoot[R]{\thepage}
  \fancyfootoffset{3.5cm}
}
\setlength{\footskip}{20pt}

%% style the chapter/section fonts
\chapterfont{\color{dark}\fontsize{20}{16.8}\selectfont}
\sectionfont{\color{dark}\fontsize{20}{16.8}\selectfont}
\subsectionfont{\color{dark}\fontsize{14}{16.8}\selectfont}
\titleformat{\subsection}
  {\sffamily\Large\bfseries}{\thesection}{1em}{}[{\titlerule[0.8pt]}]
  
% left align title
\makeatletter
\renewcommand{\maketitle}{\bgroup\setlength{\parindent}{0pt}
\begin{flushleft}
  {\sffamily\huge\textbf{\MakeUppercase{\@title}}} \vspace{0.3cm} \newline
  {\Large {\@subtitle}} \newline
  \@author
\end{flushleft}\egroup
}
\makeatother

%% Use some custom fonts
\setsansfont{Ubuntu}[
    Path=_extensions/nrennie/PrettyPDF/Ubuntu/,
    Scale=0.9,
    Extension = .ttf,
    UprightFont=*-Regular,
    BoldFont=*-Bold,
    ItalicFont=*-Italic,
    ]

\setmainfont{Ubuntu}[
    Path=_extensions/nrennie/PrettyPDF/Ubuntu/,
    Scale=0.9,
    Extension = .ttf,
    UprightFont=*-Regular,
    BoldFont=*-Bold,
    ItalicFont=*-Italic,
    ]
\usepackage{booktabs}
\usepackage{caption}
\usepackage{longtable}
\usepackage{colortbl}
\usepackage{array}
\usepackage{anyfontsize}
\usepackage{multirow}
\KOMAoption{captions}{tableheading}
\makeatletter
\@ifpackageloaded{tcolorbox}{}{\usepackage[skins,breakable]{tcolorbox}}
\@ifpackageloaded{fontawesome5}{}{\usepackage{fontawesome5}}
\definecolor{quarto-callout-color}{HTML}{909090}
\definecolor{quarto-callout-note-color}{HTML}{0758E5}
\definecolor{quarto-callout-important-color}{HTML}{CC1914}
\definecolor{quarto-callout-warning-color}{HTML}{EB9113}
\definecolor{quarto-callout-tip-color}{HTML}{00A047}
\definecolor{quarto-callout-caution-color}{HTML}{FC5300}
\definecolor{quarto-callout-color-frame}{HTML}{acacac}
\definecolor{quarto-callout-note-color-frame}{HTML}{4582ec}
\definecolor{quarto-callout-important-color-frame}{HTML}{d9534f}
\definecolor{quarto-callout-warning-color-frame}{HTML}{f0ad4e}
\definecolor{quarto-callout-tip-color-frame}{HTML}{02b875}
\definecolor{quarto-callout-caution-color-frame}{HTML}{fd7e14}
\makeatother
\makeatletter
\@ifpackageloaded{caption}{}{\usepackage{caption}}
\AtBeginDocument{%
\ifdefined\contentsname
  \renewcommand*\contentsname{Table of contents}
\else
  \newcommand\contentsname{Table of contents}
\fi
\ifdefined\listfigurename
  \renewcommand*\listfigurename{List of Figures}
\else
  \newcommand\listfigurename{List of Figures}
\fi
\ifdefined\listtablename
  \renewcommand*\listtablename{List of Tables}
\else
  \newcommand\listtablename{List of Tables}
\fi
\ifdefined\figurename
  \renewcommand*\figurename{Figure}
\else
  \newcommand\figurename{Figure}
\fi
\ifdefined\tablename
  \renewcommand*\tablename{Table}
\else
  \newcommand\tablename{Table}
\fi
}
\@ifpackageloaded{float}{}{\usepackage{float}}
\floatstyle{ruled}
\@ifundefined{c@chapter}{\newfloat{codelisting}{h}{lop}}{\newfloat{codelisting}{h}{lop}[chapter]}
\floatname{codelisting}{Listing}
\newcommand*\listoflistings{\listof{codelisting}{List of Listings}}
\makeatother
\makeatletter
\makeatother
\makeatletter
\@ifpackageloaded{caption}{}{\usepackage{caption}}
\@ifpackageloaded{subcaption}{}{\usepackage{subcaption}}
\makeatother
\makeatletter
\@ifpackageloaded{tcolorbox}{}{\usepackage[skins,breakable]{tcolorbox}}
\makeatother
\makeatletter
\@ifundefined{shadecolor}{\definecolor{shadecolor}{rgb}{.97, .97, .97}}{}
\makeatother
\makeatletter
\@ifundefined{codebgcolor}{\definecolor{codebgcolor}{named}{light}}{}
\makeatother
\makeatletter
\ifdefined\Shaded\renewenvironment{Shaded}{\begin{tcolorbox}[colback={codebgcolor}, boxrule=0pt, breakable, enhanced, sharp corners, frame hidden]}{\end{tcolorbox}}\fi
\makeatother
\usepackage{bookmark}
\IfFileExists{xurl.sty}{\usepackage{xurl}}{} % add URL line breaks if available
\urlstyle{same}
\hypersetup{
  pdftitle={Practical},
  colorlinks=true,
  linkcolor={highlight},
  filecolor={Maroon},
  citecolor={Blue},
  urlcolor={highlight},
  pdfcreator={LaTeX via pandoc}}


\title{Practical}
\author{}
\date{}
\begin{document}
\maketitle

\pagestyle{mystyle}


\textbf{Aim of this practical:}

In this first practical we are going to learn how fit a point process
model to transect data using \texttt{inlabru}

\section{Distance Sampling}\label{distance-sampling}

In this practical we will:

\begin{itemize}
\tightlist
\item
  Fit a spatial distance sampling model
\item
  Estimate animal abundance
\item
  Compare models that use different detection functions
\end{itemize}

Libraries to load:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(dplyr)}
\FunctionTok{library}\NormalTok{(INLA)}
\FunctionTok{library}\NormalTok{(ggplot2)}
\FunctionTok{library}\NormalTok{(patchwork)}
\FunctionTok{library}\NormalTok{(inlabru)     }
\FunctionTok{library}\NormalTok{(sf)}
\CommentTok{\# load some libraries to generate nice map plots}
\FunctionTok{library}\NormalTok{(scico)}
\FunctionTok{library}\NormalTok{(mapview)}
\end{Highlighting}
\end{Shaded}

\subsection{The data}\label{the-data}

In the next exercise, we will explore data from a combination of several
NOAA shipboard surveys conducted on pan-tropical spotted dolphins in the
Gulf of Mexico. The data set is available in \texttt{inlabru}
(originally obtained from the \texttt{dsm} R package) and contains the
following information:

\begin{itemize}
\item
  A total of 47 observations of groups of dolphins were detected. The
  group size was recorded, as well as the Beaufort sea state at the time
  of the observation.
\item
  Transect width is 16 km, i.e.~maximal detection distance 8 km
  (transect half-width 8 km).
\end{itemize}

We can load and visualize the data as follows:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mexdolphin }\OtherTok{\textless{}{-}}\NormalTok{ mexdolphin\_sf}
\NormalTok{mexdolphin}\SpecialCharTok{$}\NormalTok{depth }\OtherTok{\textless{}{-}}\NormalTok{ mexdolphin}\SpecialCharTok{$}\NormalTok{depth }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{mutate}\NormalTok{(}\AttributeTok{depth=}\FunctionTok{scale}\NormalTok{(depth)}\SpecialCharTok{\%\textgreater{}\%}\FunctionTok{c}\NormalTok{())}
\FunctionTok{mapviewOptions}\NormalTok{(}\AttributeTok{basemaps =} \FunctionTok{c}\NormalTok{( }\StringTok{"OpenStreetMap.DE"}\NormalTok{))}

\FunctionTok{mapview}\NormalTok{(mexdolphin}\SpecialCharTok{$}\NormalTok{points,}\AttributeTok{zcol=}\StringTok{"size"}\NormalTok{)}\SpecialCharTok{+}
  \FunctionTok{mapview}\NormalTok{(mexdolphin}\SpecialCharTok{$}\NormalTok{samplers)}\SpecialCharTok{+}
 \FunctionTok{mapview}\NormalTok{(mexdolphin}\SpecialCharTok{$}\NormalTok{ppoly )}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
file:////private/var/folders/66/sbcktl916ln9wbwvt5hnfw0h0000gn/T/RtmpZ5fN6j/file15797292b085f/widget157974832aa16.html screenshot completed
\end{verbatim}

\pandocbounded{\includegraphics[keepaspectratio]{practical1_compiler_files/figure-pdf/unnamed-chunk-4-1.pdf}}

\subsection{The workflow}\label{the-workflow}

To model the density of spotted dolphins we take a thinned point process
model of the form:

\begin{equation}\phantomsection\label{eq-thinned_pp}{
p(\mathbf{y} | \lambda)  \propto \exp \left( -\int_\Omega \lambda(\mathbf{s}) p(\mathbf{s}) \mathrm{d}\mathbf{s} \right) \prod_{i=1}^n \lambda(\mathbf{s}_i) p(\mathbf{s}_i)) 
}\end{equation}

When fitting a distance sampling model we need to fulfill the following
tasks:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Build the mesh
\item
  Define the SPDE representation of the spatial GF. This includes
  defining the priors for the range and sd of the spatial GF
\item
  Define the \emph{components} of the linear predictor. This includes
  the spatial GF and all eventual covariates
\item
  Define the observation model using the \texttt{bru\_obs()} function
\item
  Run the model using the \texttt{bru()} function
\end{enumerate}

\subsubsection{Building the mesh}\label{building-the-mesh}

The first task is to build the mesh that covers the area of interest.
For this purpose we use the function \texttt{fm\_mesh\_2d}. To do so, we
need to define the area of interest. We can either use a predefined
boundary or create a non convex hull surrounding the location of the
specie sightseeings

\subsection{non-covex hull}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{boundary0 }\OtherTok{=} \FunctionTok{fm\_nonconvex\_hull}\NormalTok{(mexdolphin}\SpecialCharTok{$}\NormalTok{points,}\AttributeTok{convex =} \SpecialCharTok{{-}}\FloatTok{0.1}\NormalTok{)}

\NormalTok{mesh\_0 }\OtherTok{=} \FunctionTok{fm\_mesh\_2d}\NormalTok{(}\AttributeTok{boundary =}\NormalTok{ boundary0,}
                          \AttributeTok{max.edge =} \FunctionTok{c}\NormalTok{(}\DecValTok{30}\NormalTok{, }\DecValTok{150}\NormalTok{), }\CommentTok{\# The largest allowed triangle edge length.}
                          \AttributeTok{cutoff =} \DecValTok{15}\NormalTok{,}
                          \AttributeTok{crs =} \FunctionTok{fm\_crs}\NormalTok{(mexdolphin}\SpecialCharTok{$}\NormalTok{points))}
\FunctionTok{ggplot}\NormalTok{() }\SpecialCharTok{+} \FunctionTok{gg}\NormalTok{(mesh\_0)}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{practical1_compiler_files/figure-pdf/unnamed-chunk-5-1.pdf}}

\subsection{domain boundary}

The \texttt{mexdolphin} object contains a predefined region of interest
which can be accessed through \texttt{mexdolphin\$ppoly}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mesh\_1 }\OtherTok{=} \FunctionTok{fm\_mesh\_2d}\NormalTok{(}\AttributeTok{boundary =}\NormalTok{ mexdolphin}\SpecialCharTok{$}\NormalTok{ppoly,}
                    \AttributeTok{max.edge =} \FunctionTok{c}\NormalTok{(}\DecValTok{30}\NormalTok{, }\DecValTok{150}\NormalTok{),}
                    \AttributeTok{cutoff =} \DecValTok{15}\NormalTok{,}
                    \AttributeTok{crs =} \FunctionTok{fm\_crs}\NormalTok{(mexdolphin}\SpecialCharTok{$}\NormalTok{points))}
\FunctionTok{ggplot}\NormalTok{() }\SpecialCharTok{+} \FunctionTok{gg}\NormalTok{(mesh\_1)}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{practical1_compiler_files/figure-pdf/unnamed-chunk-6-1.pdf}}

Key parameters in mesh construction include: \texttt{max.edge} for
maximum triangle edge lengths, \texttt{offset} for inner and outer
extensions (to prevent edge effects), and cutoff to avoid overly small
triangles in clustered areas.

\begin{tcolorbox}[enhanced jigsaw, colback=white, bottomtitle=1mm, toprule=.15mm, coltitle=black, breakable, bottomrule=.15mm, titlerule=0mm, opacitybacktitle=0.6, leftrule=.75mm, colframe=quarto-callout-note-color-frame, left=2mm, opacityback=0, rightrule=.15mm, toptitle=1mm, title=\textcolor{quarto-callout-note-color}{\faInfo}\hspace{0.5em}{Note}, arc=.35mm, colbacktitle=quarto-callout-note-color!10!white]

\textbf{General guidelines for creating the mesh}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Create triangulation meshes with \texttt{fm\_mesh\_2d()}
\item
  Move undesired boundary effects away from the domain of interest by
  extending to a smooth external boundary
\item
  Use a coarser resolution in the extension to reduce computational cost
  (\texttt{max.edge=c(inner,\ outer)})
\item
  Use a fine resolution (subject to available computational resources)
  for the domain of interest (inner correlation range) and filter out
  small input point clusters (0 \textless{} \texttt{cutoff} \textless{}
  inner)
\item
  Coastlines and similar can be added to the domain specification in
  \texttt{fm\_mesh\_2d()} through the \texttt{boundary} argument.
\end{enumerate}

\end{tcolorbox}

\begin{tcolorbox}[enhanced jigsaw, colback=white, bottomtitle=1mm, toprule=.15mm, coltitle=black, breakable, bottomrule=.15mm, titlerule=0mm, opacitybacktitle=0.6, leftrule=.75mm, colframe=quarto-callout-warning-color-frame, left=2mm, opacityback=0, rightrule=.15mm, toptitle=1mm, title={Task}, arc=.35mm, colbacktitle=quarto-callout-warning-color!10!white]

Look at the documentation for the \texttt{fm\_mesh\_2d} function typing

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{?fm\_mesh\_2d}
\end{Highlighting}
\end{Shaded}

play around with the different options and create different meshes. You
can compare these against a pre-computed mesh available by typing
\texttt{plot(mexdolphin\$mesh)}

The \emph{rule of thumb} is that your mesh should be:

\begin{itemize}
\tightlist
\item
  fine enough to well represent the spatial variability of your process,
  but not too fine in order to avoid computation burden
\item
  the triangles should be regular, avoid long and thin triangles.
\item
  The mesh should contain a buffer around your area of interest (this is
  what is defined in the \texttt{offset} option) in order to avoid
  boundary artefact in the estimated variance.
\end{itemize}

\end{tcolorbox}

\textbf{Projecting the covariate}

For point process models the spatial covariate has to cover the whole
domain including the out mesh. To achieve this we can:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Convert the \texttt{sf} spatial object containing the covariate values
  (i.e., depth) to a raster object using the \texttt{st\_rasterize}
  function form \texttt{stars} which can then be transformed into a
  \texttt{terra} raster as follows:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(terra)}
\FunctionTok{library}\NormalTok{(stars)}
\CommentTok{\# Convert sf to stars raster}
\NormalTok{stars\_raster }\OtherTok{\textless{}{-}} \FunctionTok{st\_rasterize}\NormalTok{(mexdolphin}\SpecialCharTok{$}\NormalTok{depth[, }\StringTok{"depth"}\NormalTok{])}
\CommentTok{\# Convert stars to terra raster if needed}
\NormalTok{terra\_raster }\OtherTok{\textless{}{-}} \FunctionTok{rast}\NormalTok{(stars\_raster)}
\end{Highlighting}
\end{Shaded}
\item
  Then, we can extend the raster resolution and use the
  \texttt{bru\_fill\_missing} function to fill-in the missing values
  with the nearest available value using the following code:

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Extend raster ext by 5 \% of the original raster}
\NormalTok{re }\OtherTok{\textless{}{-}} \FunctionTok{extend}\NormalTok{(terra\_raster, }\FunctionTok{ext}\NormalTok{(terra\_raster)}\SpecialCharTok{*}\FloatTok{2.1}\NormalTok{)}
\CommentTok{\# Convert to an sf spatial object}
\NormalTok{re\_df }\OtherTok{\textless{}{-}}\NormalTok{ re }\SpecialCharTok{\%\textgreater{}\%}\NormalTok{ stars}\SpecialCharTok{::}\FunctionTok{st\_as\_stars}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}  \FunctionTok{st\_as\_sf}\NormalTok{(}\AttributeTok{na.rm=}\NormalTok{F)}
\CommentTok{\# fill in missing values using the original raster }
\NormalTok{re\_df}\SpecialCharTok{$}\NormalTok{depth }\OtherTok{\textless{}{-}} \FunctionTok{bru\_fill\_missing}\NormalTok{(terra\_raster,re\_df,re\_df}\SpecialCharTok{$}\NormalTok{depth)}
\CommentTok{\# store the projectes values as a raster}
\NormalTok{depth\_rast\_p }\OtherTok{\textless{}{-}}\NormalTok{ stars}\SpecialCharTok{::}\FunctionTok{st\_rasterize}\NormalTok{(re\_df) }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{rast}\NormalTok{()}
\end{Highlighting}
\end{Shaded}
\end{enumerate}

\begin{center}
\pandocbounded{\includegraphics[keepaspectratio]{practical1_compiler_files/figure-pdf/unnamed-chunk-10-1.pdf}}
\end{center}

\subsubsection{Define the SPDE representation of the spatial
GF}\label{define-the-spde-representation-of-the-spatial-gf}

To define the SPDE representation of the spatial GF we use the function
\texttt{inla.spde2.pcmatern}. This takes as input the mesh we have
defined and the PC-priors definition for \(\rho\) and \(\sigma\) (the
range and the marginal standard deviation of the field).

PC priors Gaussian Random field are defined in (Fuglstad et al.~2018).
From a practical perspective for the range \(\rho\) you need to define
two paramters \(\rho_0\) and \(p_{\rho}\) such that you believe it is
reasonable that

\[
P(\rho<\rho_0)=p_{\rho}
\]

while for the marginal variance \(\sigma\) you need to define two
parameters \(\sigma_0\) and \(p_{\sigma}\) such that you believe it is
reasonable that

\[
P(\sigma>\sigma_0)=p_{\sigma}
\]

\begin{tcolorbox}[enhanced jigsaw, colback=white, bottomtitle=1mm, toprule=.15mm, coltitle=black, breakable, bottomrule=.15mm, titlerule=0mm, opacitybacktitle=0.6, leftrule=.75mm, colframe=quarto-callout-tip-color-frame, left=2mm, opacityback=0, rightrule=.15mm, toptitle=1mm, title={Question}, arc=.35mm, colbacktitle=quarto-callout-tip-color!10!white]

Take a look at the code below and select which of the following
statements about the specified Mat√©rn PC priors are true.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{spde\_model }\OtherTok{\textless{}{-}} \FunctionTok{inla.spde2.pcmatern}\NormalTok{(mexdolphin}\SpecialCharTok{$}\NormalTok{mesh,}
  \AttributeTok{prior.sigma =} \FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\FloatTok{0.01}\NormalTok{),}
  \AttributeTok{prior.range =} \FunctionTok{c}\NormalTok{(}\DecValTok{50}\NormalTok{, }\FloatTok{0.01}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{itemize}
\tightlist
\item
  \begin{enumerate}
  \def\labelenumi{(\Alph{enumi})}
  \tightlist
  \item
    there is probability of 0.01 that the spatial range is greater or
    equal than 50\\
  \end{enumerate}
\item
  \begin{enumerate}
  \def\labelenumi{(\Alph{enumi})}
  \setcounter{enumi}{1}
  \tightlist
  \item
    the probability that the spatial range is smaller than 50 is very
    small\\
  \end{enumerate}
\item
  \begin{enumerate}
  \def\labelenumi{(\Alph{enumi})}
  \setcounter{enumi}{2}
  \tightlist
  \item
    the probability that the marginal standard deviation is smaller than
    2 is very small\\
  \end{enumerate}
\item
  \begin{enumerate}
  \def\labelenumi{(\Alph{enumi})}
  \setcounter{enumi}{3}
  \tightlist
  \item
    there is probability of 0.99 that the marginal standard deviation is
    less or equal than 2
  \end{enumerate}
\end{itemize}

\end{tcolorbox}

\subsubsection{Define the components of the linear
predictor}\label{define-the-components-of-the-linear-predictor}

We have now defined a mesh and a SPDE representation of the spatial GF.
We now need to define the model components.

First, we need to define the detection function. Here, we will define a
half-normal detection probability function. This must take distance as
its first argument and the linear predictor of the sigma parameter as
its second:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{hn }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(distance, sigma) \{}
  \FunctionTok{exp}\NormalTok{(}\SpecialCharTok{{-}}\FloatTok{0.5} \SpecialCharTok{*}\NormalTok{ (distance }\SpecialCharTok{/}\NormalTok{ sigma)}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

We need to now separately define the components of the model including
the SPDE model, the Intercept, the effect of depth and the detection
function parameter \texttt{sigma}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cmp }\OtherTok{\textless{}{-}} \ErrorTok{\textasciitilde{}} \FunctionTok{space}\NormalTok{(}\AttributeTok{main =}\NormalTok{ geometry, }\AttributeTok{model =}\NormalTok{ spde\_model) }\SpecialCharTok{+}
  \FunctionTok{sigma}\NormalTok{(}\DecValTok{1}\NormalTok{,}
    \AttributeTok{prec.linear =} \DecValTok{1}\NormalTok{,}
    \AttributeTok{marginal =} \FunctionTok{bm\_marginal}\NormalTok{(qexp, pexp, dexp, }\AttributeTok{rate =} \DecValTok{1} \SpecialCharTok{/} \DecValTok{8}\NormalTok{)}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{depth}\NormalTok{(depth\_rast\_p}\SpecialCharTok{$}\NormalTok{depth,}\AttributeTok{model=}\StringTok{"linear"}\NormalTok{)}\SpecialCharTok{+}
  \FunctionTok{Intercept}\NormalTok{(}\DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{tcolorbox}[enhanced jigsaw, colback=white, bottomtitle=1mm, toprule=.15mm, coltitle=black, breakable, bottomrule=.15mm, titlerule=0mm, opacitybacktitle=0.6, leftrule=.75mm, colframe=quarto-callout-note-color-frame, left=2mm, opacityback=0, rightrule=.15mm, toptitle=1mm, title=\textcolor{quarto-callout-note-color}{\faInfo}\hspace{0.5em}{Note}, arc=.35mm, colbacktitle=quarto-callout-note-color!10!white]

To control the prior distribution for the \texttt{sigma} parameter, we
use a transformation mapper that converts a latent variable into an
exponentially distributed variable with expectation 8 (this is a
somewhat arbitrary value, but motivated by the maximum observation
distance W)

The \texttt{marginal} argument in the \texttt{sigma} component specifies
the transformation function taking N(0,1) to Exponential(1/8).

\end{tcolorbox}

The formula, which describes how these components are combined to form
the linear predictor

\[\log \color{red}{\tilde{\lambda}(s)} = \overbrace{\log \lambda (s)}^{\beta_0 + \beta_1 x(s) + \xi(s)} + \overbrace{\log \color{red}{g(d(s))}}^{-0.5~d(\mathbf{s})^2\sigma^{-2}}\]

\begin{tcolorbox}[enhanced jigsaw, colback=white, bottomtitle=1mm, toprule=.15mm, coltitle=black, breakable, bottomrule=.15mm, titlerule=0mm, opacitybacktitle=0.6, leftrule=.75mm, colframe=quarto-callout-warning-color-frame, left=2mm, opacityback=0, rightrule=.15mm, toptitle=1mm, title={Task}, arc=.35mm, colbacktitle=quarto-callout-warning-color!10!white]

Complete the code below to define the formula

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{eta }\OtherTok{\textless{}{-}}\NormalTok{ ... }\SpecialCharTok{+} \FunctionTok{log}\NormalTok{(}\DecValTok{2}\NormalTok{)  }
\end{Highlighting}
\end{Shaded}

Click here to see the solution

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{eta }\OtherTok{\textless{}{-}}\NormalTok{ geometry }\SpecialCharTok{+}\NormalTok{ distance }\SpecialCharTok{\textasciitilde{}}\NormalTok{ space }\SpecialCharTok{+}  
  \FunctionTok{log}\NormalTok{(}\FunctionTok{hn}\NormalTok{(distance, sigma)) }\SpecialCharTok{+}
\NormalTok{  depth }\SpecialCharTok{+}
\NormalTok{  Intercept }\SpecialCharTok{+} \FunctionTok{log}\NormalTok{(}\DecValTok{2}\NormalTok{)  }
\end{Highlighting}
\end{Shaded}

\end{tcolorbox}

Here, the \texttt{log(2)} offset in the predictor takes care of the
two-sided detections

\subsubsection{Define the observation
model}\label{define-the-observation-model}

\texttt{inlabru} has support for latent Gaussian Cox processes through
the \texttt{cp} likelihood family. To fit a point process model recall
that we need to approximate the integral in using a numerical
integration scheme as:

\[
\approx\exp\left(-\sum_{k=1}^{N_k}w_k\lambda(s_k)\right)\prod_{i=1}^n \lambda(\mathbf{s}_i)
\]

Thus, we first create our integration scheme using the \texttt{fm\_int}
function by specifying integration domains for the spatial and distance
dimensions.

Here we use the same points to define the SPDE approximation and to
approximate the integral in Equation~\ref{eq-thinned_pp}, so that the
integration weight and SPDE weights are consistent with each other. We
also need to explicitly integrate over the distance dimension so we use
the \texttt{fm\_mesh\_1d()} to create mesh over the samplers (which are
the transect lines in this dataset, so we need to tell \texttt{inlabru}
about the strip half-width).

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# build integration scheme}
\NormalTok{distance\_domain }\OtherTok{\textless{}{-}}  \FunctionTok{fm\_mesh\_1d}\NormalTok{(}\FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{8}\NormalTok{,}
                              \AttributeTok{length.out =} \DecValTok{30}\NormalTok{))}
\NormalTok{ips }\OtherTok{=} \FunctionTok{fm\_int}\NormalTok{(}\FunctionTok{list}\NormalTok{(}\AttributeTok{geometry =}\NormalTok{ mexdolphin}\SpecialCharTok{$}\NormalTok{mesh,}
                  \AttributeTok{distance =}\NormalTok{ distance\_domain),}
             \AttributeTok{samplers =}\NormalTok{ mexdolphin}\SpecialCharTok{$}\NormalTok{samplers)}
\end{Highlighting}
\end{Shaded}

Now, we just need to supply the \texttt{sf} object as our data and the
integration scheme \texttt{ips}:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{lik }\OtherTok{=} \FunctionTok{bru\_obs}\NormalTok{(}\StringTok{"cp"}\NormalTok{,}
              \AttributeTok{formula =}\NormalTok{ eta,}
              \AttributeTok{data =}\NormalTok{ mexdolphin}\SpecialCharTok{$}\NormalTok{points,}
              \AttributeTok{ips =}\NormalTok{ ips)}
\end{Highlighting}
\end{Shaded}

Then we fit the model, passing both the components and the observational
model

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fit }\OtherTok{=} \FunctionTok{bru}\NormalTok{(cmp, lik)}
\end{Highlighting}
\end{Shaded}

\begin{tcolorbox}[enhanced jigsaw, colback=white, bottomtitle=1mm, toprule=.15mm, coltitle=black, breakable, bottomrule=.15mm, titlerule=0mm, opacitybacktitle=0.6, leftrule=.75mm, colframe=quarto-callout-note-color-frame, left=2mm, opacityback=0, rightrule=.15mm, toptitle=1mm, title=\textcolor{quarto-callout-note-color}{\faInfo}\hspace{0.5em}{Note}, arc=.35mm, colbacktitle=quarto-callout-note-color!10!white]

\texttt{inlabru} supports a shortcut for defining the integration points
using the \texttt{domain} and \texttt{samplers} argument of
\texttt{bru\_obs()}. This \texttt{domain} argument expects a list of
named domains with inputs that are then internally passed to
\texttt{fm\_int()} to build the integration scheme. The
\texttt{samplers} argument is used to define subsets of the domain over
which the integral should be computed. An equivalent way to define the
same model as above is:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{lik }\OtherTok{=} \FunctionTok{bru\_obs}\NormalTok{(}\AttributeTok{formula =}\NormalTok{ eta, }
              \AttributeTok{data =}\NormalTok{ mexdolphin}\SpecialCharTok{$}\NormalTok{points, }
              \AttributeTok{family =} \StringTok{"cp"}\NormalTok{,}
              \AttributeTok{domain =} \FunctionTok{list}\NormalTok{(}
                \AttributeTok{geometry =}\NormalTok{ mesh,}
                \AttributeTok{distance =} \FunctionTok{fm\_mesh\_1d}\NormalTok{(}\FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{8}\NormalTok{, }\AttributeTok{length.out =} \DecValTok{30}\NormalTok{))),}
              \AttributeTok{samplers =}\NormalTok{ mexdolphin}\SpecialCharTok{$}\NormalTok{samplers)}
\end{Highlighting}
\end{Shaded}

\end{tcolorbox}

\subsection{Visualize model Results}\label{visualize-model-results}

\subsubsection{Posterior summaries}\label{posterior-summaries}

We can use the \texttt{fit\$summary.fixed} and \texttt{summary.hyperpar}
to obtain posterior summaries of the model parameters.

\begin{table}
\fontsize{12.0pt}{14.0pt}\selectfont
\begin{tabular*}{\linewidth}{@{\extracolsep{\fill}}l|rrr}
\toprule
 & mean & 0.025quant & 0.975quant \\ 
\midrule\addlinespace[2.5pt]
sigma & -0.05 & -0.46 & 0.36 \\ 
depth & 0.57 & 0.14 & 1.05 \\ 
Intercept & -8.09 & -9.28 & -7.14 \\ 
Range for space & 344.79 & 122.58 & 813.71 \\ 
Stdev for space & 0.85 & 0.42 & 1.49 \\ 
\bottomrule
\end{tabular*}
\end{table}

Look at the SPDE parameter posteriors as follows:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{( }\FunctionTok{spde.posterior}\NormalTok{(fit, }\StringTok{"space"}\NormalTok{, }\AttributeTok{what =} \StringTok{"range"}\NormalTok{)) }\SpecialCharTok{+}
\FunctionTok{plot}\NormalTok{( }\FunctionTok{spde.posterior}\NormalTok{(fit, }\StringTok{"space"}\NormalTok{, }\AttributeTok{what =} \StringTok{"log.variance"}\NormalTok{))  }
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{practical1_compiler_files/figure-pdf/unnamed-chunk-22-1.pdf}}

\subsubsection{Model predictions}\label{model-predictions}

We now want to extract the estimated posterior mean and sd of spatial
GF. To do this we first need to define a grid of points where we want to
predict. We do this using the function \texttt{fm\_pixel()} which
creates a regular grid of points covering the mesh

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pxl }\OtherTok{\textless{}{-}} \FunctionTok{fm\_pixels}\NormalTok{(mexdolphin}\SpecialCharTok{$}\NormalTok{mesh, }\AttributeTok{dims =} \FunctionTok{c}\NormalTok{(}\DecValTok{200}\NormalTok{, }\DecValTok{100}\NormalTok{), }\AttributeTok{mask =}\NormalTok{ mexdolphin}\SpecialCharTok{$}\NormalTok{ppoly)}
\end{Highlighting}
\end{Shaded}

then compute the prediction for both the spatial GF and the linear
predictor (spatial GF + intercept + depth covariate)

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pr.int }\OtherTok{=} \FunctionTok{predict}\NormalTok{(fit, pxl, }\SpecialCharTok{\textasciitilde{}}\FunctionTok{data.frame}\NormalTok{(}\AttributeTok{spatial =}\NormalTok{ space,}
                                      \AttributeTok{lambda =} \FunctionTok{exp}\NormalTok{(Intercept }\SpecialCharTok{+}\NormalTok{ depth }\SpecialCharTok{+}\NormalTok{ space)))}
\end{Highlighting}
\end{Shaded}

Finally, we can plot the maps of the spatial effect

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{() }\SpecialCharTok{+} \FunctionTok{geom\_sf}\NormalTok{(}\AttributeTok{data =}\NormalTok{ pr.int}\SpecialCharTok{$}\NormalTok{spatial,}\FunctionTok{aes}\NormalTok{(}\AttributeTok{color =}\NormalTok{ mean)) }\SpecialCharTok{+} \FunctionTok{scale\_color\_scico}\NormalTok{() }\SpecialCharTok{+} \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"Posterior mean"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{practical1_compiler_files/figure-pdf/unnamed-chunk-25-1.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{() }\SpecialCharTok{+} \FunctionTok{geom\_sf}\NormalTok{(}\AttributeTok{data =}\NormalTok{ pr.int}\SpecialCharTok{$}\NormalTok{spatial,}\FunctionTok{aes}\NormalTok{(}\AttributeTok{color =}\NormalTok{ sd)) }\SpecialCharTok{+} \FunctionTok{scale\_color\_scico}\NormalTok{() }\SpecialCharTok{+} \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"Posterior sd"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{practical1_compiler_files/figure-pdf/unnamed-chunk-25-2.pdf}}

\textbf{Note} The posterior sd is lowest at the observation points. Note
how the posterior sd is inflated around the border, this is the ``border
effect'' due to the SPDE representation.

\begin{tcolorbox}[enhanced jigsaw, colback=white, bottomtitle=1mm, toprule=.15mm, coltitle=black, breakable, bottomrule=.15mm, titlerule=0mm, opacitybacktitle=0.6, leftrule=.75mm, colframe=quarto-callout-warning-color-frame, left=2mm, opacityback=0, rightrule=.15mm, toptitle=1mm, title={Task}, arc=.35mm, colbacktitle=quarto-callout-warning-color!10!white]

Using the predictions stored in \texttt{pr.int}, produce a map of the
posterior mean intensity.

Take hint

Recall that the predicted intensity is given by
\(\lambda(s) = \exp\{\beta_0+ \beta_1~ \text{depth}(s)+\xi(s)\}\)

Click here to see the solution

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{() }\SpecialCharTok{+} 
  \FunctionTok{geom\_sf}\NormalTok{(}\AttributeTok{data =}\NormalTok{ pr.int}\SpecialCharTok{$}\NormalTok{lambda,}\FunctionTok{aes}\NormalTok{(}\AttributeTok{color =}\NormalTok{ mean)) }\SpecialCharTok{+}
  \FunctionTok{scale\_color\_scico}\NormalTok{(}\AttributeTok{palette =} \StringTok{"imola"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"Posterior mean"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{practical1_compiler_files/figure-pdf/unnamed-chunk-26-1.pdf}}

\end{tcolorbox}

We can predict the detection function in a similar fashion. Here, we
should make sure that it doesn't try to evaluate the effects of
components that can't be evaluated using the given input data.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{distdf }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}\AttributeTok{distance =} \FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{8}\NormalTok{, }\AttributeTok{length.out =} \DecValTok{100}\NormalTok{))}
\NormalTok{dfun }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(fit, distdf, }\SpecialCharTok{\textasciitilde{}} \FunctionTok{hn}\NormalTok{(distance, sigma))}
\FunctionTok{plot}\NormalTok{(dfun)}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{practical1_compiler_files/figure-pdf/unnamed-chunk-27-1.pdf}}

\subsection{Abundance estimates}\label{abundance-estimates}

The mean expected number of animals can be computed by integrating the
intensity over the region of interest as follows:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{predpts }\OtherTok{\textless{}{-}} \FunctionTok{fm\_int}\NormalTok{(mexdolphin}\SpecialCharTok{$}\NormalTok{mesh, mexdolphin}\SpecialCharTok{$}\NormalTok{ppoly)}
\NormalTok{Lambda }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(fit, predpts, }\SpecialCharTok{\textasciitilde{}} \FunctionTok{sum}\NormalTok{(weight }\SpecialCharTok{*} \FunctionTok{exp}\NormalTok{(space }\SpecialCharTok{+}\NormalTok{ Intercept)))}
\NormalTok{Lambda}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
      mean       sd   q0.025     q0.5   q0.975   median sd.mc_std_err
1 256.5226 54.74652 178.1482 251.2055 381.2504 251.2055      4.387893
  mean.mc_std_err
1        6.352231
\end{verbatim}

To fully propagate the uncertainty on the expected number animals we can
draw Monte Carlo samples from the fitted model as follows (this could
take a couple of minutes):

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{Ns }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(}\DecValTok{50}\NormalTok{, }\DecValTok{450}\NormalTok{, }\AttributeTok{by =} \DecValTok{1}\NormalTok{)}
\NormalTok{Nest }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(fit, predpts,}
  \SpecialCharTok{\textasciitilde{}} \FunctionTok{data.frame}\NormalTok{(}
    \AttributeTok{N =}\NormalTok{ Ns,}
    \AttributeTok{density =} \FunctionTok{dpois}\NormalTok{(}
\NormalTok{      Ns,}
      \AttributeTok{lambda =} \FunctionTok{sum}\NormalTok{(weight }\SpecialCharTok{*} \FunctionTok{exp}\NormalTok{(space }\SpecialCharTok{+}\NormalTok{ Intercept))}
\NormalTok{    )}
\NormalTok{  ),}
  \AttributeTok{n.samples =} \DecValTok{2000}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

We can compare this with a simpler ``plug-in'' approximation:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{Nest }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{bind\_rows}\NormalTok{(}
  \FunctionTok{cbind}\NormalTok{(Nest, }\AttributeTok{Method =} \StringTok{"Posterior"}\NormalTok{),}
  \FunctionTok{data.frame}\NormalTok{(}
    \AttributeTok{N =}\NormalTok{ Nest}\SpecialCharTok{$}\NormalTok{N,}
    \AttributeTok{mean =} \FunctionTok{dpois}\NormalTok{(Nest}\SpecialCharTok{$}\NormalTok{N, }\AttributeTok{lambda =}\NormalTok{ Lambda}\SpecialCharTok{$}\NormalTok{mean),}
    \AttributeTok{mean.mc\_std\_err =} \DecValTok{0}\NormalTok{,}
    \AttributeTok{Method =} \StringTok{"Plugin"}
\NormalTok{  )}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

Then, we can visualize the result as follows:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ Nest) }\SpecialCharTok{+}
  \FunctionTok{geom\_line}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ N, }\AttributeTok{y =}\NormalTok{ mean, }\AttributeTok{colour =}\NormalTok{ Method)) }\SpecialCharTok{+}
  \FunctionTok{geom\_ribbon}\NormalTok{(}
    \FunctionTok{aes}\NormalTok{(}
      \AttributeTok{x =}\NormalTok{ N,}
      \AttributeTok{ymin =}\NormalTok{ mean }\SpecialCharTok{{-}} \DecValTok{2} \SpecialCharTok{*}\NormalTok{ mean.mc\_std\_err,}
      \AttributeTok{ymax =}\NormalTok{ mean }\SpecialCharTok{+} \DecValTok{2} \SpecialCharTok{*}\NormalTok{ mean.mc\_std\_err,}
      \AttributeTok{fill =}\NormalTok{ Method,}
\NormalTok{    ),}
    \AttributeTok{alpha =} \FloatTok{0.2}
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{geom\_line}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ N, }\AttributeTok{y =}\NormalTok{ mean, }\AttributeTok{colour =}\NormalTok{ Method)) }\SpecialCharTok{+}
  \FunctionTok{ylab}\NormalTok{(}\StringTok{"Probability mass function"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{practical1_compiler_files/figure-pdf/unnamed-chunk-31-1.pdf}}

\subsection{Model checks}\label{model-checks}

Lastly, we can assess the goodness-of-fit of the models by comparing the
observed counts across different distance bins and the expected counts
and their associated uncertainty:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{bc }\OtherTok{\textless{}{-}} \FunctionTok{bincount}\NormalTok{(}
  \AttributeTok{result =}\NormalTok{ fit,}
  \AttributeTok{observations =}\NormalTok{ mexdolphin}\SpecialCharTok{$}\NormalTok{points}\SpecialCharTok{$}\NormalTok{distance,}
  \AttributeTok{breaks =} \FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FunctionTok{max}\NormalTok{(mexdolphin}\SpecialCharTok{$}\NormalTok{points}\SpecialCharTok{$}\NormalTok{distance), }\AttributeTok{length.out =} \DecValTok{9}\NormalTok{),}
  \AttributeTok{predictor =}\NormalTok{ distance }\SpecialCharTok{\textasciitilde{}} \FunctionTok{hn}\NormalTok{(distance, sigma)}
\NormalTok{)}
\FunctionTok{attributes}\NormalTok{(bc)}\SpecialCharTok{$}\NormalTok{ggp}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{practical1_compiler_files/figure-pdf/unnamed-chunk-32-1.pdf}}

\begin{tcolorbox}[enhanced jigsaw, colback=white, bottomtitle=1mm, toprule=.15mm, coltitle=black, breakable, bottomrule=.15mm, titlerule=0mm, opacitybacktitle=0.6, leftrule=.75mm, colframe=quarto-callout-warning-color-frame, left=2mm, opacityback=0, rightrule=.15mm, toptitle=1mm, title={Task}, arc=.35mm, colbacktitle=quarto-callout-warning-color!10!white]

Fit a model using a hazard detection function instead and compare the
GoF of this model with that from the half-normal detection model. Recall
that the hazard detection function is given by:

\[
g(\mathbf{s}|\sigma) = 1 - \exp(-(d(\mathbf{s})/\sigma)^{-1})
\]

Take hint

The hazard function can be codes as:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{hr }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(distance, sigma) \{}
  \DecValTok{1} \SpecialCharTok{{-}} \FunctionTok{exp}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{(distance }\SpecialCharTok{/}\NormalTok{ sigma)}\SpecialCharTok{\^{}{-}}\DecValTok{1}\NormalTok{)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

You can use the same prior for the \texttt{sigma} parameter as for the
half-Normal model (such parameters aren't always comparable, but in this
example it's a reasonable choice). You can also use the \texttt{lgcp}
function as a shortcut to fit the model (type \texttt{?lgcp} for further
details).

Click here to see the solution

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{formula1 }\OtherTok{\textless{}{-}}\NormalTok{ geometry }\SpecialCharTok{+}\NormalTok{ distance }\SpecialCharTok{\textasciitilde{}}\NormalTok{ space }\SpecialCharTok{+}
  \FunctionTok{log}\NormalTok{(}\FunctionTok{hr}\NormalTok{(distance, sigma)) }\SpecialCharTok{+}
\NormalTok{  Intercept }\SpecialCharTok{+} \FunctionTok{log}\NormalTok{(}\DecValTok{2}\NormalTok{)}

\CommentTok{\# here we use the shorcut to specify the model}
\NormalTok{fit1 }\OtherTok{\textless{}{-}} \FunctionTok{lgcp}\NormalTok{(}
  \AttributeTok{components =}\NormalTok{ cmp,}
\NormalTok{  mexdolphin}\SpecialCharTok{$}\NormalTok{points,}
  \AttributeTok{samplers =}\NormalTok{ mexdolphin}\SpecialCharTok{$}\NormalTok{samplers,}
  \AttributeTok{domain =} \FunctionTok{list}\NormalTok{(}
    \AttributeTok{geometry =}\NormalTok{ mexdolphin}\SpecialCharTok{$}\NormalTok{mesh,}
    \AttributeTok{distance =} \FunctionTok{fm\_mesh\_1d}\NormalTok{(}\FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{8}\NormalTok{, }\AttributeTok{length.out =} \DecValTok{30}\NormalTok{))}
\NormalTok{  ),}
  \AttributeTok{formula =}\NormalTok{ formula1}
\NormalTok{)}

\NormalTok{bc1 }\OtherTok{\textless{}{-}} \FunctionTok{bincount}\NormalTok{(}
  \AttributeTok{result =}\NormalTok{ fit1,}
  \AttributeTok{observations =}\NormalTok{ mexdolphin}\SpecialCharTok{$}\NormalTok{points}\SpecialCharTok{$}\NormalTok{distance,}
  \AttributeTok{breaks =} \FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FunctionTok{max}\NormalTok{(mexdolphin}\SpecialCharTok{$}\NormalTok{points}\SpecialCharTok{$}\NormalTok{distance), }\AttributeTok{length.out =} \DecValTok{9}\NormalTok{),}
  \AttributeTok{predictor =}\NormalTok{ distance }\SpecialCharTok{\textasciitilde{}} \FunctionTok{hn}\NormalTok{(distance, sigma)}
\NormalTok{)}
\FunctionTok{attributes}\NormalTok{(bc1)}\SpecialCharTok{$}\NormalTok{ggp}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{practical1_compiler_files/figure-pdf/unnamed-chunk-34-1.pdf}}

\end{tcolorbox}

\section{Space-time model for transect survey
data}\label{space-time-model-for-transect-survey-data}

In this practical we will:

\begin{itemize}
\tightlist
\item
  Fit a spatio-temporal model to transect survey data.
\end{itemize}

Libraries to load:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(dplyr)}
\FunctionTok{library}\NormalTok{(INLA)}
\FunctionTok{library}\NormalTok{(ggplot2)}
\FunctionTok{library}\NormalTok{(patchwork)}
\FunctionTok{library}\NormalTok{(inlabru)     }
\FunctionTok{library}\NormalTok{(sf)}
\CommentTok{\# load some libraries to generate nice map plots}
\FunctionTok{library}\NormalTok{(scico)}
\FunctionTok{library}\NormalTok{(mapview)}
\end{Highlighting}
\end{Shaded}

\subsection{The data}\label{the-data-1}

In the next exercise, we will work with simulate spatiotemporal transect
survey data from the \texttt{MRSea} package which is available on
\texttt{inlabru}.

We can load and visualize the data as follows:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mrsea }\OtherTok{\textless{}{-}}\NormalTok{ inlabru}\SpecialCharTok{::}\NormalTok{mrsea}

\FunctionTok{ggplot}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_fm}\NormalTok{(}\AttributeTok{data =}\NormalTok{ mrsea}\SpecialCharTok{$}\NormalTok{mesh) }\SpecialCharTok{+}
  \FunctionTok{gg}\NormalTok{(mrsea}\SpecialCharTok{$}\NormalTok{boundary) }\SpecialCharTok{+}
  \FunctionTok{gg}\NormalTok{(mrsea}\SpecialCharTok{$}\NormalTok{samplers) }\SpecialCharTok{+}
  \FunctionTok{gg}\NormalTok{(mrsea}\SpecialCharTok{$}\NormalTok{points, }\AttributeTok{size =} \FloatTok{0.5}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{facet\_wrap}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{season) }\SpecialCharTok{+}
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"MRSea observation seasons"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{practical1_compiler_files/figure-pdf/unnamed-chunk-72-1.pdf}}

\subsection{The workflow}\label{the-workflow-1}

\subsubsection{The Model}\label{the-model}

For computational purposes we will assume perfect detection along the
transects and thus, the spatiotemporal animal density is modelled using
a point process model of the form:

\[
p(\mathbf{y} | \lambda)  \propto \exp \left( -\int_\Omega \lambda(\mathbf{s,t}) \mathrm{d}\mathbf{s,t} \right) \prod_{i=1}^n \lambda(\mathbf{s}_i,t)) 
\]

\subsubsection{The SPDE model}\label{the-spde-model}

First, we define the SPDE model:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{matern }\OtherTok{\textless{}{-}} \FunctionTok{inla.spde2.pcmatern}\NormalTok{(mrsea}\SpecialCharTok{$}\NormalTok{mesh,}
  \AttributeTok{prior.sigma =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.1}\NormalTok{, }\FloatTok{0.01}\NormalTok{),}
  \AttributeTok{prior.range =} \FunctionTok{c}\NormalTok{(}\DecValTok{10}\NormalTok{, }\FloatTok{0.01}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\subsubsection{Model components}\label{model-components}

In this example we will employ a spatio-temporal SPDE component. Note
how the \texttt{group} and \texttt{ngroup} parameters are employed to
let the SPDE model know about the name of the time dimension (season)
and the total number of distinct points in time. Further control of the
spatio-temporal filed can be passed as a list through the the
\texttt{control.group} argument. In this case, we specify an
\texttt{iid} effect to describe how the spatial field evolves in time
(this could be change to accommodate a time dependent structure such as
an AR(1) model).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cmp }\OtherTok{\textless{}{-}} \ErrorTok{\textasciitilde{}} \FunctionTok{Intercept}\NormalTok{(}\DecValTok{1}\NormalTok{) }\SpecialCharTok{+} 
  \FunctionTok{space\_time}\NormalTok{(}
\NormalTok{    geometry,}
    \AttributeTok{model =}\NormalTok{ matern,}
    \AttributeTok{group =}\NormalTok{ season,}
    \AttributeTok{ngroup =} \DecValTok{4}\NormalTok{,}
    \AttributeTok{control.group =} \FunctionTok{list}\NormalTok{(}\AttributeTok{model=}\StringTok{"iid"}\NormalTok{)}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{tcolorbox}[enhanced jigsaw, colback=white, bottomtitle=1mm, toprule=.15mm, coltitle=black, breakable, bottomrule=.15mm, titlerule=0mm, opacitybacktitle=0.6, leftrule=.75mm, colframe=quarto-callout-warning-color-frame, left=2mm, opacityback=0, rightrule=.15mm, toptitle=1mm, title={Task}, arc=.35mm, colbacktitle=quarto-callout-warning-color!10!white]

Complete the following code to define the linear predictor:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{eta }\OtherTok{\textless{}{-}}\NormalTok{ ... }\SpecialCharTok{+}\NormalTok{ ... }\SpecialCharTok{\textasciitilde{}}\NormalTok{ ... }\SpecialCharTok{+}\NormalTok{ ...}
\end{Highlighting}
\end{Shaded}

Click here to see the solution

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{eta }\OtherTok{\textless{}{-}}\NormalTok{ geometry }\SpecialCharTok{+}\NormalTok{ season }\SpecialCharTok{\textasciitilde{}}\NormalTok{ space\_time }\SpecialCharTok{+}
\NormalTok{  Intercept }
\end{Highlighting}
\end{Shaded}

\end{tcolorbox}

\subsubsection{Build the observational
model}\label{build-the-observational-model}

We can now build the integration scheme using the \texttt{fm\_int()}
function by specifying the domain and samplers arguments. Note that
omitting the season dimension from domain would lead to aggregation of
all sampling regions over time.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ips }\OtherTok{\textless{}{-}} \FunctionTok{fm\_int}\NormalTok{(}
  \AttributeTok{domain =} \FunctionTok{list}\NormalTok{(}\AttributeTok{geometry =}\NormalTok{ mrsea}\SpecialCharTok{$}\NormalTok{mesh, }\AttributeTok{season =} \DecValTok{1}\SpecialCharTok{:}\DecValTok{4}\NormalTok{),}
  \AttributeTok{samplers =}\NormalTok{ mrsea}\SpecialCharTok{$}\NormalTok{samplers}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{tcolorbox}[enhanced jigsaw, colback=white, bottomtitle=1mm, toprule=.15mm, coltitle=black, breakable, bottomrule=.15mm, titlerule=0mm, opacitybacktitle=0.6, leftrule=.75mm, colframe=quarto-callout-warning-color-frame, left=2mm, opacityback=0, rightrule=.15mm, toptitle=1mm, title={Task}, arc=.35mm, colbacktitle=quarto-callout-warning-color!10!white]

Complete the following arguments to construct the observational model
and the fit the model using the \texttt{bru} function

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{lik }\OtherTok{=} \FunctionTok{bru\_obs}\NormalTok{(}\AttributeTok{formula =}\NormalTok{ ...,}
    \AttributeTok{family =}\NormalTok{ ...,}
    \AttributeTok{data =}\NormalTok{ ...,}
    \AttributeTok{ips  =}\NormalTok{ ...)}
\NormalTok{fit }\OtherTok{=} \FunctionTok{bru}\NormalTok{(..., ...)}
\end{Highlighting}
\end{Shaded}

Click here to see the solution

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{lik }\OtherTok{=} \FunctionTok{bru\_obs}\NormalTok{(}\AttributeTok{formula =}\NormalTok{ eta,}
    \AttributeTok{family =} \StringTok{"cp"}\NormalTok{,}
    \AttributeTok{data =}\NormalTok{ mrsea}\SpecialCharTok{$}\NormalTok{points,}
    \AttributeTok{ips  =}\NormalTok{ ips)}
\NormalTok{fit }\OtherTok{=} \FunctionTok{bru}\NormalTok{(cmp, lik)}
\end{Highlighting}
\end{Shaded}

\end{tcolorbox}

Once the model is fitted we can predict and plot the intensity for all
seasons:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ppxl }\OtherTok{\textless{}{-}} \FunctionTok{fm\_pixels}\NormalTok{(mrsea}\SpecialCharTok{$}\NormalTok{mesh, }\AttributeTok{mask =}\NormalTok{ mrsea}\SpecialCharTok{$}\NormalTok{boundary, }\AttributeTok{format =} \StringTok{"sf"}\NormalTok{)}
\NormalTok{ppxl\_all }\OtherTok{\textless{}{-}} \FunctionTok{fm\_cprod}\NormalTok{(ppxl, }\FunctionTok{data.frame}\NormalTok{(}\AttributeTok{season =} \FunctionTok{seq\_len}\NormalTok{(}\DecValTok{4}\NormalTok{)))}

\NormalTok{lambda1 }\OtherTok{\textless{}{-}} \FunctionTok{predict}\NormalTok{(}
\NormalTok{  fit,}
\NormalTok{  ppxl\_all,}
  \SpecialCharTok{\textasciitilde{}} \FunctionTok{data.frame}\NormalTok{(}\AttributeTok{season =}\NormalTok{ season, }\AttributeTok{lambda =} \FunctionTok{exp}\NormalTok{(space\_time }\SpecialCharTok{+}\NormalTok{ Intercept))}
\NormalTok{)}

\NormalTok{pl1 }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{gg}\NormalTok{(lambda1, }\AttributeTok{geom =} \StringTok{"tile"}\NormalTok{, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{fill =}\NormalTok{ q0}\FloatTok{.5}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{gg}\NormalTok{(mrsea}\SpecialCharTok{$}\NormalTok{points, }\AttributeTok{size =} \FloatTok{0.3}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{facet\_wrap}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{season) }\SpecialCharTok{+}
  \FunctionTok{coord\_sf}\NormalTok{()}
\NormalTok{pl1}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{practical1_compiler_files/figure-pdf/unnamed-chunk-80-1.pdf}}




\end{document}
